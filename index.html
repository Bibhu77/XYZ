<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Blood Donation System</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 400px; width: 100%; border-radius: 0.5rem; }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center">
    <header class="w-full bg-gradient-to-r from-green-500 to-teal-500 text-white py-6 text-center shadow-lg">
        <h1 class="text-4xl font-bold">Smart Blood Donation System</h1>
        <p class="mt-2 text-lg">Find compatible blood donors instantly</p>
    </header>

    <main class="w-full max-w-4xl mx-auto mt-8 px-4">
        <!-- Form Section -->
        <section class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Enter Recipient Details</h2>
            <form id="match-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="blood_type" class="block text-sm font-medium text-gray-700">Blood Type</label>
                    <select id="blood_type" name="blood_type" class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500">
                        <option value="O-">O-</option>
                        <option value="O+">O+</option>
                        <option value="A-" selected>A-</option>
                        <option value="A+" selected>A+</option>
                        <option value="B-">B-</option>
                        <option value="B+">B+</option>
                        <option value="AB-">AB-</option>
                        <option value="AB+">AB+</option>
                    </select>
                </div>
                <div>
                    <label for="location" class="block text-sm font-medium text-gray-700">Location</label>
                    <input type="text" id="location" name="location" value="New York, NY" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500">
                </div>
                <div>
                    <label for="urgency" class="block text-sm font-medium text-gray-700">Urgency (1-10)</label>
                    <input type="number" id="urgency" name="urgency" min="1" max="10" value="8" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="md:col-span-2">
                    <button type="submit" class="w-full bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 transition duration-300 flex items-center justify-center">
                        <span>Find Donors</span>
                        <div id="loading-spinner" class="loading-spinner ml-2"></div>
                    </button>
                </div>
            </form>
        </section>

        <!-- Map Section -->
        <section class="mt-8">
            <div id="map" class="shadow-md"></div>
        </section>

        <!-- Results Section -->
        <section id="results" class="mt-8"></section>
    </main>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize the map
        const map = L.map('map').setView([40.7306, -73.9352], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        // Handle form submission
        document.getElementById('match-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const blood_type = document.getElementById('blood_type').value;
            const location = document.getElementById('location').value;
            const urgency = parseInt(document.getElementById('urgency').value);
            const resultsDiv = document.getElementById('results');
            const spinner = document.getElementById('loading-spinner');

            // Show loading spinner
            spinner.style.display = 'block';
            resultsDiv.innerHTML = '';

            try {
                // Use Nominatim API to fetch coordinates
                const geocodeResponse = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(location)}&format=json&limit=1`);
                const geocodeData = await geocodeResponse.json();
                if (!geocodeResponse.ok || geocodeData.length === 0) {
                    throw new Error('Failed to fetch coordinates for the selected location.');
                }

                const { lat, lon } = geocodeData[0];

                const response = await fetch('https://smart-blood-donation.onrender.com/match', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ blood_type, latitude: lat, longitude: lon, urgency })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();

                // Clear previous markers
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker) map.removeLayer(layer);
                });

                if (data.status === 'success' && data.matches.length > 0) {
                    // Add recipient marker
                    L.marker([latitude, longitude], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41]
                        })
                    }).addTo(map)
                        .bindPopup('Recipient').openPopup();

                    // Display matches
                    let results = `<div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold text-gray-800 mb-4">Matched Donors</h3><ul class="space-y-4">`;
                    data.matches.forEach(match => {
                        const hospitalDistance = match.hospital_distance === null ? 'No low-stock hospitals' : `${match.hospital_distance.toFixed(2)} km`;
                        results += `
                            <li class="border-b pb-2">
                                <p><strong>Donor ID:</strong> ${match.donor_id}</p>
                                <p><strong>Blood Type:</strong> ${match.blood_type}</p>
                                <p><strong>Distance to Recipient:</strong> ${match.distance.toFixed(2)} km</p>
                                <p><strong>Distance to Hospital:</strong> ${hospitalDistance}</p>
                                <p><strong>Urgency:</strong> ${match.urgency_score}</p>
                                <p><strong>SMS Status:</strong> ${data.sms_status}</p>
                            </li>`;
                        // Add donor marker
                        L.marker([match.donor_latitude, match.donor_longitude]).addTo(map)
                            .bindPopup(`Donor ${match.donor_id}: ${match.blood_type}`);
                    });
                    results += `</ul></div>`;
                    resultsDiv.innerHTML = results;

                    // Adjust map view
                    map.setView([latitude, longitude], 10);
                } else {
                    resultsDiv.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md"><p class="text-red-500">No donors found.</p></div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md"><p class="text-red-500">Error: ${error.message}</p></div>`;
                console.error('Fetch error:', error);
            } finally {
                spinner.style.display = 'none';
            }
        });
    </script>
</body>
</html>
